<?phpdefined('BASEPATH') OR exit('No direct script access allowed');class Perawatan_model extends CI_Model {  var $table = 'tbl_jadwal_perawatan';  var $column_order   = array('A.company_id', 'A.judul', 'A.document_id', 'A.aktivasi', 'A.created_date', 'B.nama', 'A.id',                              'A.created_by', null);  var $column_search  = array('A.company_id', 'A.judul', 'A.document_id', 'A.aktivasi', 'A.created_date', 'B.nama', 'A.id',                              'A.created_by');  var $order = array('A.id' => 'desc');  public function __construct()  {    parent::__construct();    $this->load->database();  }  private function _get_datatables_query()  {    //$this->db->from($this->table. " A");    $this->db->select("A.id, A.company_id, A.judul, A.document_id, A.aktivasi, A.created_date, A.created_by, B.nama");    $this->db->from("tbl_jadwal_perawatan A");    $this->db->join("tbl_perusahaan B", "B.id = A.id", "left");    $i = 0;      foreach ($this->column_search as $item) // loop column     {      if($_POST['search']['value']) // if datatable send POST for search      {                if($i===0) // first loop        {          $this->db->group_start(); // open bracket. query Where with OR clause better with bracket. because maybe can combine with other WHERE with AND.          $this->db->like($item, $_POST['search']['value']);        }        else        {          $this->db->or_like($item, $_POST['search']['value']);        }        if(count($this->column_search) - 1 == $i) //last loop          $this->db->group_end(); //close bracket      }      $i++;    }        if(isset($_POST['order'])) // here order processing    {      $this->db->order_by($this->column_order[$_POST['order']['0']['column']], $_POST['order']['0']['dir']);    }     else if(isset($this->order))    {      $order = $this->order;      $this->db->order_by(key($order), $order[key($order)]);    }  }  function get_datatables()  {    $this->_get_datatables_query();    if($_POST['length'] != -1)    $this->db->limit($_POST['length'], $_POST['start']);    $query = $this->db->get();    return $query->result();  }  function count_filtered()  {    $this->_get_datatables_query();    $query = $this->db->get();    return $query->num_rows();  }  public function count_all()  {    $this->db->from($this->table);    return $this->db->count_all_results();  }  public function get_by_id($id)  {    $this->db->from($this->table);    $this->db->where('id', $id);    $query = $this->db->get();    return $query->row();  }  public function get_by_id_with_company($hader_id, $tgl_perencanaan)  {    // $this->db->select('a.*, b.nama');    // $this->db->from('tbl_jadwal_perawatan a');    // $this->db->join('tbl_perusahaan b', 'b.id = a.company_id');    // $this->db->where('a.id', $id);    // $query = $this->db->get();    // return $query->row();    $sql    =  "SELECT a.*, b.nama, c.*                 FROM tbl_jadwal_perawatan a                LEFT JOIN tbl_perusahaan b ON b.id = a.company_id                LEFT JOIN tbl_jadwal_perawatan_detail c ON c.id_header = a.id                WHERE a.id = '$hader_id' AND c.tgl_perencanaan = '$tgl_perencanaan'";    $query  = $this->db->query($sql);        return $query->row();  }  public function get_data_by_id($id) {    $this->db->select("b.tgl_perencanaan AS start, b.tgl_perencanaan AS end, a.judul AS title");    $this->db->from("tbl_jadwal_perawatan a");    $this->db->join("tbl_jadwal_perawatan_detail b", "b.id_header = a.id", "left");    $this->db->join("tbl_perusahaan c", "c.id = a.company_id", "left");    $this->db->where('a.id', $id);    $this->db->order_by('b.tgl_perencanaan', 'ASC');    $query = $this->db->get();    return $query->result();  }  public function get_data_all_perawatan() {    $this->db->select("b.tgl_perencanaan AS start, b.tgl_perencanaan AS end, CONCAT_WS(' - ', a.judul, c.nama) AS title");    $this->db->from("tbl_jadwal_perawatan a");    $this->db->join("tbl_jadwal_perawatan_detail b", "b.id_header = a.id", "left");    $this->db->join("tbl_perusahaan c", "c.id = a.company_id", "left");    $this->db->order_by('b.tgl_perencanaan', 'ASC');    $query = $this->db->get();    return $query->result();  }  public function get_data_detail_by_id($id) {    $sql    =  "SELECT a.judul, a.document_id, b.*, c.nama, c.id AS id_perusahaan                FROM tbl_jadwal_perawatan a                LEFT JOIN tbl_jadwal_perawatan_detail b ON b.id_header = a.id                LEFT JOIN tbl_perusahaan c ON c.id = a.company_id                WHERE a.id = '$id'                ORDER BY b.tgl_perencanaan ASC";    $query  = $this->db->query($sql);    return $query->result();  }  public function save($data)  {    $this->db->insert($this->table, $data);    return $this->db->insert_id();  }  public function update($where, $data)  {    $this->db->update($this->table, $data, $where);    return $this->db->affected_rows();  }  public function delete_by_id($id)  {    $this->db->where('id', $id);    $this->db->delete($this->table);  }  public function delete_detail_by_id($id)  {    $this->db->where('id_header', $id);    $this->db->delete('tbl_jadwal_perawatan_detail');  }  public function get_laporan_jadwal_perawatan($perusahaan_id) {    $where    = "";    if ($perusahaan_id == 'all') {      $where  = "";    } else {      $where  = " WHERE c.id = '$perusahaan_id' ";    }        //GET DATA    $sql = "SELECT a.judul, a.document_id, b.*, c.nama,             c.id AS id_perusahaan, d.tgl_pengerjaan            FROM tbl_jadwal_perawatan a            LEFT JOIN tbl_jadwal_perawatan_detail b ON b.id_header = a.id            LEFT JOIN tbl_perusahaan c ON c.id = a.company_id            LEFT JOIN (              SELECT * FROM tbl_transaksi_perawatan GROUP BY id_detail            ) d ON d.id_detail = b.id_detail            $where            ORDER BY b.tgl_perencanaan ASC";    $sql = $this->db->query($sql);    $res = $sql->result();    return $res;  }}